<!doctype html >
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <title>Rest API Authentication Example</title>
        <!-- Bootstrap 4 CSS and custom CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />
        <link rel="stylesheet" type="text/css" href="css/custom.css?1" />
        <link rel="stylesheet" type="text/css" href="css/style.css?1" />
    </head>
<body>
    <!-- jQuery & Bootstrap 4 JavaScript libraries -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <!-- jQuery & Bootstrap 4 JavaScript libraries -->
    
    <!-- navbar -->
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
        <a class="navbar-brand" href="#">Скины Дота2</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
                <a class="nav-item nav-link" href="#" id='home'>Главная</a>
            </div>
            <div class="navbar-nav ml-auto">
                <a class="nav-item nav-link" href="#" id='korzina'>Корзина</a>
                
                <a class="nav-item nav-link" href="#" id='update_account' value="Профиль"><img src="" href="#" alt="Профиль" style="display: none; width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 10px;" id='profile_photo' /></a>
                <a class="nav-item nav-link" href="#" id='logout'>Выход</a>
                
                <a class="nav-item nav-link" href="#" id='authorize'>Авторизация</a>
            </div>
        </div>
    </nav>
    <!-- /navbar -->

    <!-- container -->
    <main role="main" class="container starter-template">

                <div id="notification" class="notification"></div>
                <!-- where prompt / messages will appear -->
                <div id="response"></div>
                
                <!-- where main content will appear-->
                <div id="content"></div>
                
    </main>
    <!-- /container -->
    
    <!-- Модальное окно для редактирования профиля -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" role="dialog" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel">Обновить профиль</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Форма для редактирования профиля -->
                    <form id='update_account_form' enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="firstname">Имя</label>
                            <input type="text" class="form-control" name="firstname" id="firstname" required />
                        </div>
                        <div class="form-group">
                            <label for="lastname">Фамилия</label>
                            <input type="text" class="form-control" name="lastname" id="lastname" required />
                        </div>
                        <div class="form-group">
                            <label for="password">Пароль</label>
                            <input type="password" class="form-control" name="password" id="password" />
                        </div>
                        <div class="form-group">
                            <label for="profile_photo">Фото профиля</label>
                            <!-- Отображение текущего фото -->
                            <img src="" id="current_photo" style="width: 100px; height: auto;">
                            <input type="file" class="form-control" name="profile_photo" id="profile_photo" />
                            <!-- Скрытое поле для хранения пути к текущему фото -->
                            <input type="hidden" name="current_photo_path" id="current_photo_path" value="URL_ТЕКУЩЕГО_ФОТО" />
                        </div>
                        
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    <button type="submit" class="btn btn-primary" form="update_account_form">Сохранить изменения</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Модальное окно для добовления товара -->
    <div class="modal fade" id="addProductModal" tabindex="-1" role="dialog" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">Добавление нового товара</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="addProductForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="productName">Название</label>
                            <input type="text" class="form-control" id="productName" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="productPrice">Цена</label>
                            <input type="number" class="form-control" id="productPrice" name="price" required>
                        </div>
                        <div class="form-group">
                            <label for="productPhoto">Фотография товара</label>
                            <input type="file" class="form-control-file" id="productPhoto" name="path_photo">
                        </div>
                        <div class="form-group">
                            <label for="productCategory">Категория</label>
                            <select class="form-control" id="productCategory" name="category_id">
                                <!-- Добавьте дополнительные категории здесь -->
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-primary">Добавить товар</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Модальное окно для редактирования товара -->
    <div class="modal fade" id="editProductModal" tabindex="-1" role="dialog" aria-labelledby="editProductModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editProductModalLabel">Редактирование товара</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <form id="editProductForm">
            <div class="modal-body">
              <!-- Скрытое поле для ID товара -->
              <input type="hidden" id="editProductId" name="id">
              <div class="form-group">
                <label for="editProductName">Название</label>
                <input type="text" class="form-control" id="editProductName" placeholder="" name="name" required>
              </div>
              <div class="form-group">
                <label for="editProductPrice">Цена</label>
                <input type="text" class="form-control" id="editProductPrice" placeholder="" name="price" required>
              </div>
              <!-- Добавьте другие поля по необходимости -->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
              <button type="submit" class="btn btn-primary">Сохранить изменения</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- Модальное окно для добавления категории -->
    <div class="modal fade" id="categoryModal" tabindex="-1" role="dialog" aria-labelledby="categoryModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalLabel">Добавить категорию</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addCategoryForm">
                        <div class="form-group">
                            <label for="categoryName">Название категории</label>
                            <input type="text" class="form-control" id="categoryName" placeholder="Введите название категории">
                        </div>
                        <button type="submit" class="btn btn-primary">Сохранить категорию</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Модальное окно для удаления категории -->
    <div class="modal fade" id="deleteCategoryModal" tabindex="-1" role="dialog" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteCategoryModalLabel">Удалить категорию</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="deleteCategoryForm">
                        <div class="form-group">
                            <label for="categoryToDeleteId">ID категории для удаления</label>
                            <input type="number" class="form-control" id="categoryToDeleteId" placeholder="Введите ID категории" required>
                        </div>
                        <button type="submit" class="btn btn-danger">Удалить категорию</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Модальное окно для оформления заказа -->
    <div class="modal fade" id="orderModal" tabindex="-1" role="dialog" aria-labelledby="orderModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="orderModalLabel">Оформление заказа</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="order-info-form">
                <div class="form-group">
                    <label>Имя пользователя:</label>
                    <input type="text" class="form-control" id="username" readonly>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" class="form-control" id="useremail" readonly>
                </div>
                <div class="form-group">
                    <label>Trade ссылка:</label>
                    <input type="text" class="form-control" id="trade-link" placeholder="https://steamcommunity.com/tradeoffer/new/?partner=#&token=#"required>
                </div>
                <div class="form-group">
                    <label>Способ оплаты:</label>
                    <select class="form-control" id="payment-method" required>
                        <option value="card">Карта</option>
                        <option value="cash">Наличными</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Оформить заказ</button>
            </form>
            <!-- ... -->
          </div>
        </div>
      </div>
    </div>
    <!-- Модальное окно для деталей заказа -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" role="dialog" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailsModalLabel">Детали заказа</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="order-details-container">
                    <!-- Здесь будут отображаться детали заказа -->
                </div>
            </div>
        </div>
    </div>
    
    
    <script>
        $(document).ready(function(){
            //Отображение главной страницы при входе на сайт 
            showHomePage();
            
            // Обработчик клика для кнопки "Авторизация"
            $(document).on('click', '#authorize', function() {
                setCookie("jwt", "", 1);
                showAuthorizePage();
            });
            // Функция для показа страницы авторизации
            function showAuthorizePage() {
                $.get("Pages/authorize.html", function(html) {
                    $('#content').html(html);
                    clearResponse();
                    // Показываем раздел входа и скрываем раздел регистрации
                    
                    showLoggedOutMenu();
                    
                });
            }
            
            // trigger when registration form is submitted
            $(document).on('submit', '#sign_up_form', function(){
                // get form data
                var sign_up_form=$(this);
                var form_data=JSON.stringify(sign_up_form.serializeObject());
                // submit form data to api
                $.ajax({
                    url: "api/data/user/create_user.php",
                    type : "POST",
                    contentType : 'application/json',
                    data : form_data,
                    success : function(result) {
                        // if response is a success, tell the user it was a successful sign up & empty the input boxes
                        //$('#response').html("<div class='alert alert-success'>Successful sign up. Please login.</div>");
                        showNotification("Successful sign up. Please login.", false);
                        sign_up_form.find('input').val('');
                    },
                    error: function(xhr, resp, text){
                        // on error, tell the user sign up failed
                        //$('#response').html("<div class='alert alert-danger'>Unable to sign up. Please contact admin.</div>");
                        showNotification("Unable to sign up. Please contact admin.", true);
                    }
                });
                return false;
            });
            // trigger when login form is submitted
            $(document).on('submit', '#login_form', function(e){
                e.preventDefault(); // Предотвратить стандартную отправку формы
            
                var login_form = $(this);
                var form_data = login_form.serializeObject();
            
                // отправить данные формы на сервер
                $.ajax({
                    url: "api/data/user/login.php",
                    type : "POST",
                    contentType : 'application/json',
                    data : JSON.stringify(form_data),
                    success : function(result){
                        // сохранить jwt в cookie
                        setCookie("jwt", result.jwt, 1);
            
                        // показать домашнюю страницу и сообщить пользователю об успешном входе
                        showHomePage();
                        //$('#response').html("<div class='alert alert-success'>Successful login.</div>");
                        showNotification("Успешный вход!", false);
                        
                        // декодировать JWT и обновить фото профиля
                        var jwt_data = parseJwt(result.jwt);
                        if(jwt_data.data.profile_photo) {
                            $('#profile_photo').attr('src',jwt_data.data.profile_photo);
                        }
                    },
                    error: function(xhr, resp, text){
                        // в случае ошибки сообщить пользователю о неудачной попытке входа
                        //$('#response').html("<div class='alert alert-danger'>Login failed. Email or password is incorrect.</div>");
                        showNotification("Login failed. Email or password is incorrect.", true);
                        login_form.find('input').val('');
                    }
                });
            });
            
            // logout the user
            $(document).on('click', '#logout', function() {
                // Удаление JWT и других данных пользователя из хранилища
                setCookie("jwt", "", 1);
                localStorage.removeItem('jwt');
                localStorage.removeItem('userPhoto');
                // Показать страницу авторизации
                showNotification("Вы вышли из аккаунта!", false);
                showAuthorizePage();
            });
            
            // функция для декодирования JWT
            function parseJwt(token) {
                var base64Url = token.split('.')[1];
                var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            
                return JSON.parse(jsonPayload);
            };
        
            // show home page
            $(document).on('click', '#home', function(){
                showHomePage();
                clearResponse();
            });
            $(document).on('click', '#korzina', function(){
                showkorzinaPage();
            });
            // show update account form
            $(document).on('click', '#update_account', function(){
                showUpdateAccountForm();
            });
            // trigger when 'update account' form is submitted
            $(document).on('submit', '#update_account_form', function(){
                // handle for update_account_form
                var update_account_form=$(this);
                // validate jwt to verify access
                var jwt = getCookie('jwt');
                // get form data
                var update_account_form_obj = update_account_form.serializeObject()
                // add jwt on the object
                update_account_form_obj.jwt = jwt;
                // convert object to json string
                var form_data=JSON.stringify(update_account_form_obj);
                // submit form data to api
                var update_account_form = new FormData(this);
                update_account_form.append('jwt', jwt);
                
                $.ajax({
                        url: "api/update_user.php", // Укажите URL вашего API для обновления пользователя
                        type : "POST",
                        contentType: false,
                        processData: false,
                        data : update_account_form,
                        success : function(result) {
                            // Уведомление пользователя об успешном обновлении
                            //$('#response').html("<div class='alert alert-success'>Account was updated.</div>");
                            showNotification("Account was updated.", false);
                            $('#editProfileModal').modal('hide');
                            showUpdateAccountForm();
                            
                        },
                        error: function(xhr, resp, text){
                            console.log(resp, text);
                            // Уведомление пользователя об ошибке
                            //$('#response').html("<div class='alert alert-danger'>Unable to update account. Please contact support.</div>");
                            showNotification("Unable to update account. Please contact support.", true);
                        }
                    });
                return false;
            });
                    
            // remove any prompt messages
            function clearResponse(){
                $('#response').html('');
            }
            
            // function to set cookie
            function setCookie(cname, cvalue, exdays) {
                var d = new Date();
                d.setTime(d.getTime() + (exdays*24*60*60*1000));
                var expires = "expires="+ d.toUTCString();
                document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
            }
        
            
            // if the user is logged out
            function showLoggedOutMenu(){
                // show login and sign up from navbar & hide logout button
                $("#authorize").show();
                $("#logout, #profile_photo").hide();
            }
            // if the user is logged in
            function showLoggedInMenu(){
                // hide login and sign up from navbar & show logout button
                $("#authorize").hide();
                $("#logout, #profile_photo").show();
            }
        
            //<---------------------------------------------------------------------------------------Home Page--------------------------------------------------------------------------------------->
            // show home page
            function showHomePage(categoryId = '') {
                var jwt = getCookie('jwt');
                var user;
                $.post("api/data/user/validate_token.php", JSON.stringify({ jwt:jwt })).done(function(result) {
                    user = result.data;
            
                    showLoggedInMenu();
            
                    if(user.role == 'admin') {
                        var adminHtml = `<div class="col-12 mb-3">
                                            <button type="button" class="btn btn-success" id="addProductBtn">Добавить товар</button>
                                            <button type="button" class="btn btn-success" id="addCategoryBtn">Добавить категорию</button>
                                            <button type="button" class="btn btn-danger" id="deleteCategoryBtn">Удалить категорию</button>
                                          </div>`;
                        $('#content').append(adminHtml);
                    }
                })
                .fail(function(result){
                    showLoggedOutMenu();
                });
            
                $('#content').load('Pages/homepage.html', function() {    
                        $('#filterForm').submit(function(e) {
                            e.preventDefault();
                            var selectedCategory = $('#categoryId').val();
                            showHomePage(selectedCategory);
                        });
                        $.ajax({
                            url: 'api/data/product/get_categories.php', // Путь к вашему серверному скрипту
                            type: 'GET',
                            success: function(categories) {
                                // Очищаем текущие опции и добавляем "Все категории"
                                var select = $('#categoryId');
                                select.empty().append($('<option>', {
                                    value: '',
                                    text: 'Все категории'
                                }));
                    
                                // Добавляем полученные категории в выпадающий список
                                categories.forEach(function(category) {
                                    select.append($('<option>', {
                                        value: category.id,
                                        text: category.name
                                    }));
                                });
                            },
                            error: function(xhr, status, error) {
                                console.error("Ошибка при получении категорий: ", error);
                            }
                        });
                        
                        getProducts(function(products) {
                            var productTemplate = $('#productTemplate').html();
                            var productsHtml = '';
                            if (products && products.length > 0) {
                                products.forEach(function(product) {
                                    var adminButtons = generateAdminButtons(product.id, user ? user.role : ''); // Используем user.role, если user определена
                                    
                                    var productHtml = productTemplate
                                        .replace(/%path_photo%/g, product.path_photo)
                                        .replace(/%name%/g, product.name)
                                        .replace(/%description%/g, product.description)
                                        .replace(/%id%/g, product.id)
                                        .replace(/%adminButtons%/g, adminButtons)
                                        .replace(/%price%/g, product.price);
                
                                    productsHtml += productHtml;
                                });
                                $('#content').append('<div class="row">' + productsHtml + '</div>');
                            } else {
                                $('#content').append('<p>Товары не найдены.</p>');
                            }
                        }, categoryId);
                    });
            
            }
            function generateAdminButtons(productId, userRole) {
                if (userRole === 'admin') {
                    return `<button type="button" class="btn btn-sm btn-outline-secondary edit-product-btn" data-product-id="${productId}">Edit</button>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-product-btn" data-product-id="${productId}">Delete</button>`;
                } else {
                    return '';
                }
            }
            // Функция для получения товаров
            function getProducts(callback, categoryId = '') {
                // Подготовка данных для запроса
                var data = {};
                if (categoryId) {
                    data.categoryId = categoryId; // Добавляем categoryId в данные запроса, если он задан
                }
            
                $.ajax({
                    url: 'api/data/product/get_products.php', // Убедитесь, что адрес верный
                    type: 'GET',
                    data: data, // Передаем данные в запросе
                    dataType: 'json',
                    success: function(response) {
                        callback(response);
                    },
                    error: function(xhr, status, error) {
                        console.error("Ошибка получения списка товаров: ", error);
                    }
                });
            }

            //adminButtons
            // Открытие модального окна категории
            $('body').on('click', '#addCategoryBtn', function() {
                // Открытие модального окна
                $('#categoryModal').modal('show');
            });
            // Обработка отправки формы категории
            $('#addCategoryForm').submit(function(event) {
                event.preventDefault(); // Предотвратить стандартную отправку формы
                var categoryName = $('#categoryName').val();
                var categoryDescription = $('#categoryDescription').val(); // Получаем описание категории
                
                // Проверка введенного названия и описания категории
                if (categoryName.trim() === '') {
                    alert('Пожалуйста, введите название категории.');
                    return;
                }
                
                // AJAX запрос для отправки названия и описания категории на сервер
                $.ajax({
                    url: 'api/data/product/add_category.php', // Укажите здесь URL серверного скрипта
                    type: 'POST',
                    data: {
                          name: categoryName // Данные, которые вы хотите отправить на сервер
                    },
                    success: function(response) {
                          // Обработка успешного ответа от сервера
                          showNotification("Категория успешно добавлена!", false);
                          showHomePage();
                    },
                    error: function(xhr, status, error) {
                          // Обработка ошибок при запросе
                          alert('Произошла ошибка при добавлении категории.');
                    }
                });
                
                // Закрыть модальное окно и очистить форму
                $('#categoryModal').modal('hide');
                $('#addCategoryForm')[0].reset();
            });
            
            // Открытие модального окна удаления категории
            $('body').on('click', '#deleteCategoryBtn', function() {
                // Открытие модального окна
                $('#deleteCategoryModal').modal('show');
            });
            // Обработка отправки формы удаления категории
            $('#deleteCategoryForm').submit(function(event) {
                event.preventDefault();
                var categoryId = $('#categoryToDeleteId').val();
                $.ajax({
                    url: 'api/data/product/delete_category.php',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ id: categoryId }),
                    success: function(response) {
                       showNotification("Категория успешно удалена!", false); // Показываем сообщение об успехе
                        $('#deleteCategoryModal').modal('hide'); // Закрываем модальное окно
                        showHomePage();
                    },
                    error: function(xhr, status, error) {
                        // Если ошибка не связана с JSON-ответом, используйте xhr.responseText
                        var errorMessage = xhr.responseJSON ? xhr.responseJSON.message : xhr.responseText;
                        alert("Ошибка: " + errorMessage); // Показываем сообщение об ошибке
                    }
                });
            });
            
            
            // Функция для открытия модального окна редактирования товара и заполнения его данными
            function editProductModal(productId) {
                $.ajax({
                    url: 'api/data/product/get_product.php', // Путь к вашему скрипту, который возвращает данные о товаре
                    type: 'GET',
                    dataType: 'json', // Указываем, что ожидаем ответ в формате JSON
                    data: { id: productId },
                    success: function(productData) {
                        // Установка значений placeholder данными о товаре
                        $('#editProductName').attr('placeholder', productData.name);
                        $('#editProductPrice').attr('placeholder', productData.price);
                        
                        // Также установите фактические значения, если хотите, чтобы поля были заполнены
                        $('#editProductId').val(productId);
                        $('#editProductName').val(productData.name);
                        $('#editProductPrice').val(productData.price);
                        
                        // Открытие модального окна
                        $('#editProductModal').modal('show');
                    },
                    error: function(xhr, status, error) {
                        // Обработка ошибок
                        console.error("Ошибка получения данных о товаре: ", error);
                    }
                });
            }
            // Обработчик нажатия на кнопку редактирования товара
            $(document).on('click', '.edit-product-btn', function() {
                var productId = $(this).data('product-id');
                editProductModal(productId); // Вызов функции для редактирования товара
            });
            $('#editProductForm').submit(function(e) {
                e.preventDefault(); // Предотвращаем стандартное поведение формы
        
                var formData = $(this).serialize(); // Сериализуем данные формы
        
                // Отправляем данные на сервер через AJAX
                $.ajax({
                    url: 'api/data/product/update_product.php', // Укажите здесь правильный путь к вашему скрипту обновления продукта
                    type: 'POST',
                    dataType: 'json',
                    data: formData,
                    success: function(response) {
                        // Здесь вы можете обработать ответ от сервера после обновления продукта
                        $('#editProductModal').modal('hide'); // Закрываем модальное окно
                        // Здесь может быть код для обновления данных на странице
                        showHomePage();
                    },
                    error: function(xhr, status, error) {
                        // Обработка ошибок при отправке данных
                        console.error("Ошибка обновления продукта: ", error);
                    }
                });
            });
            
            // Обработчик нажатия на кнопку добовления товара
            $('body').on('click', '#addProductBtn', function() {
                // Очистка формы перед открытием модального окна
                $('#addProductForm')[0].reset();
                var select = $('#productCategory');
                select.empty();
        
                // Добавляем AJAX запрос для получения категорий
                $.ajax({
                    url: 'api/data/product/get_categories.php', // Путь к вашему серверному скрипту
                    type: 'GET',
                    success: function(categories) {
                        // Добавляем полученные категории в выпадающий список
                        categories.forEach(function(category) {
                            select.append($('<option>', {
                                value: category.id,
                                text: category.name
                            }));
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error("Ошибка при получении категорий: ", error);
                    }
                });
                // Открытие модального окна
                $('#addProductModal').modal('show');
            });
            $('#addProductForm').submit(function(e) {
                e.preventDefault();
                var formData = new FormData(this);
            
                $.ajax({
                    url: 'api/create_product.php', // Путь к скрипту создания товара
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function(response) {
                        console.log(response);
                        // Обработка успешного добавления товара
                        $('#addProductModal').modal('hide'); // Закрытие модального окна
                        // Обновление списка товаров на странице
                        showHomePage();
                    },
                    error: function(xhr, status, error) {
                        // Обработка ошибок при отправке данных
                        console.error("Ошибка добавления товара: ", error);
                    }
                });
            });
            
            // Добавление обработчика событий для кнопок удаления товара
            $(document).on('click', '.delete-product-btn', function() {
                var productId = $(this).data('product-id');
                if (confirm('Вы уверены, что хотите удалить этот товар?')) {
                    $.ajax({
                        url: 'api/data/product/delete_product.php', // Путь к вашему скрипту удаления продукта
                        type: 'POST', // Или 'DELETE', если ваш API поддерживает этот метод
                        data: { id: productId },
                        success: function(response) {
                            // Товар успешно удален, обновляем список товаров
                            showHomePage();
                        },
                        error: function(xhr, status, error) {
                            // Обработка ошибок при удалении товара
                            console.error("Ошибка при удалении товара: ", error);
                        }
                    });
                }
            });
            //\adminButtons
            
            //<---------------------------------------------------------------------------------------Home Page--------------------------------------------------------------------------------------->
        
            //<---------------------------------------------------------------------------------------Korzina Page--------------------------------------------------------------------------------------->
            // show korzina page
            function showkorzinaPage() {
                // validate jwt to verify access
                var jwt = getCookie('jwt');
                $.post("api/data/user/validate_token.php", JSON.stringify({ jwt:jwt })).done(function(result) {
                    var user = result.data;
                    var html = '';
                    $.get("Pages/korzina.html", function(html) {
                        $('#content').html(html);
                        // AJAX-запрос к серверу для получения товаров в корзине
                        $.ajax({
                            url: 'api/data/korzina/get_cart_items.php', // Путь к вашему серверному скрипту
                            type: 'POST', // Убедитесь, что метод POST
                            contentType: 'application/json', // Правильный заголовок Content-Type
                            data: JSON.stringify({ user_id: user.id }),
                            dataType: 'json', // Ожидаем ответ в формате JSON
                            success: function(response) {
    
                                var cartTableBody = $('#cart-table tbody');
                                var totalPriceElement = $('#total-price');
                                var total = 0;
                                var itemNumber = 1;
                                
                                response.forEach(function(item) {
                                    total += item.price * item.quantity;
                                    var rowHtml = `
                                        <tr>
                                            <th scope="row">${itemNumber++}</th>
                                            <td><input type="checkbox" class="cart-item-checkbox" value="${item.cart_item_id}"></td>
                                            <td><img src="${item.path_photo}" alt="${item.name}" class="img-fluid" style="max-width: 100px;"></td>
                                            <td>${item.name}</td>
                                            <td>${item.price} x ${item.quantity}</td>
                                        </tr>`;
                                    cartTableBody.append(rowHtml);
                                });
                    
                                totalPriceElement.text(`Итого: ${total}`);
                            },
                            error: function(xhr, status, error) {
                                var errorMessage = xhr.responseJSON ? xhr.responseJSON.message : xhr.responseText;
                                console.error("Ошибка при получении товаров в корзине: ", errorMessage);
                            }
                        });
                    
                        
                    });
                    showLoggedInMenu();
                })// on error/fail, tell the user he needs to login to show the account page
                .fail(function(result){
                    showAuthorizePage();
                    //$('#response').html("<div class='alert alert-danger'>Please login to access the account page.</div>");
                    showNotification("Please login to access the home page.", true);
                });
            }
            
            $(document).on('click', '.add-to-cart-btn', function() {
                var jwt = getCookie('jwt');
                var productId = $(this).data('product-id');
                $.post("api/data/user/validate_token.php", JSON.stringify({ jwt:jwt })).done(function(result) {
                    var user = result.data;
                    var userId = user.id;
                    $.ajax({
                        url: 'api/data/korzina/add_to_cart.php',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ user_id: userId, product_id: productId }),
                        success: function(response) {
                            if(response.error) {
                                alert("Ошибка: " + response.error);
                            } else {
                                showNotification("Товар добавлен в корзину.", false); 
                                // Обновите здесь количество товаров в корзине, если необходимо
                            }
                        },
                        error: function(xhr, status, error) {
                            showNotification("Вы неавторизованный пользователь!", true);
                            alert("Произошла ошибка при добавлении товара в корзину.");
                        }
                    });
                })
                .fail(function(result){
                    //$('#response').html("<div class='alert alert-danger'>Please login to access the account page.</div>");
                    showNotification("Вы неавторизованный пользователь!", true);
                });
            });
            $(document).on('click', '#delete-selected-items', function() {
                // Собираем ID отмеченных товаров
                var selectedIds = $('.cart-item-checkbox:checked').map(function() {
                    return $(this).val();
                }).get();
            
                // Проверяем, что был выбран хотя бы один товар
                if (selectedIds.length === 0) {
                    alert('Выберите хотя бы один товар для удаления.');
                    return;
                }
            
                // Отправляем AJAX-запрос на сервер для удаления товаров
                $.ajax({
                    url: 'api/data/korzina/delete_selected_items.php',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ cart_item_ids: selectedIds }),
                    success: function(response) {
                        if(response.error) {
                            alert("Ошибка: " + response.error);
                        } else {
                            showNotification("Выбранные товары удалены из корзины.", false);
                            // Обновляем содержимое корзины
                            showkorzinaPage();
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("Произошла ошибка при удалении товаров из корзины.");
                    }
                });
            });
            $(document).on('click', '#checkoutBtn', function() {
                var jwt = getCookie('jwt');
                $.post("api/data/user/validate_token.php", JSON.stringify({ jwt:jwt })).done(function(result) {
                    var user = result.data;
                    // Заполнение формы данными пользователя
                    $('#username').val(user.firstname + ' ' + user.lastname);
                    $('#useremail').val(user.email);
                    // Показываем модальное окно
                    $('#orderModal').modal('show');
                }).fail(function(error) {
                    console.error("Ошибка при получении данных пользователя: ", error);
                });
            });
            // Обработка отправки формы в модальном окне
            $(document).on('submit', '#order-info-form', function(e) {
                e.preventDefault();
                var jwt = getCookie('jwt');
                var tradeLink = $('#trade-link').val();
                var paymentMethod = $('#payment-method').val();
            
                $.post("api/data/user/validate_token.php", JSON.stringify({ jwt:jwt })).done(function(result) {
                    var user = result.data;
                    var userId = user.id;
            
                    // Отправляем данные на сервер для оформления заказа
                    $.ajax({
                        url: 'api/data/korzina/process_order.php',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            user_id: userId,
                            trade_link: tradeLink,
                            payment_method: paymentMethod
                        }),
                        success: function(response) {
                            // Обработка успешного оформления заказа
                            showNotification("Заказ успешно оформлен.", false);
                            $('#orderModal').modal('hide');
                            showHomePage();
                            //$('#response').html("<div class='alert alert-success'>Ваш заказ сформирован.</div>");
                            showNotification("Ваш заказ сформирован.", false);
                        },
                        error: function(xhr, status, error) {
                            // Обработка ошибки оформления заказа
                            alert("Произошла ошибка при оформлении заказа.");
                        }
                    });
                }).fail(function(error) {
                    console.error("Ошибка при валидации пользователя: ", error);
                });
            });
            
            //<---------------------------------------------------------------------------------------Korzina Page--------------------------------------------------------------------------------------->
            
            
            // get or read cookie
            function getCookie(cname){
                var name = cname + "=";
                var decodedCookie = decodeURIComponent(document.cookie);
                var ca = decodedCookie.split(';');
                for(var i = 0; i <ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0) == ' '){
                        c = c.substring(1);
                    }
                    if (c.indexOf(name) == 0) {
                        return c.substring(name.length, c.length);
                    }
                }
                return "";
            }

            var globalUserData = null;
            function showUpdateAccountForm(){
                // validate jwt to verify access
                var jwt = getCookie('jwt');
                $.post("api/data/user/validate_token.php", JSON.stringify({ jwt:jwt })).done(function(result) {
                    var user = result.data;
                    var userId = user.id;
                    var userRole = user.role;
                    globalUserData = result.data;
                    // if response is valid, put user details in the form
                    var html = `<div class="col-12 d-flex justify-content-end align-items-center">
                                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#editProfileModal">
                                            Редактировать профиль
                                        </button>
                                    </div>
                                `;
                    if(user.role == 'admin'){
                    html += `<div id="admin-orders-container">`;
                        getAllOrders();
                    html += `</div>`;
                        
                    }else{    
                        html += `<div id="orders-container"><h3>Ваши заказы:</h3></div>`;
                        getOrders(userId, userRole);
                    }
                    clearResponse();
                    $('#content').html(html);
                    
                   
                })
                // on error/fail, tell the user he needs to login to show the account page
                .fail(function(result){
                    showAuthorizePage();
                    //$('#response').html("<div class='alert alert-danger'>Please login to access the account page.</div>");
                    showNotification("Please login to access the account page.", true);
                });
            }
            $('#editProfileModal').on('shown.bs.modal', function() {
                // Проверяем, есть ли данные пользователя
                if (globalUserData) {
                    // Заполняем форму данными пользователя
                    $('#firstname').val(globalUserData.firstname);
                    $('#lastname').val(globalUserData.lastname);
                    $('#current_photo_path').val(globalUserData.profile_photo);
                    $('#current_photo').attr('src', globalUserData.profile_photo);
                
                }
            });
            $(document).on('click', '.btn-edit-profile', function() {
                // Открытие модального окна
                $('#editProfileModal').modal('show');
            });
            
            function getOrders(userId, userRole) {
                $.ajax({
                    url: 'api/data/korzina/get_user_orders.php',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ user_id: userId }),
                    success: function(response) {
                        if(response.error) {
                            $('#orders-container').html(`<div class='alert alert-danger'>${response.error}</div>`);
                        } else {
                            if(userRole == 'user') {
                                var ordersHtml = `<div class='list-group'>`;
                                response.forEach(function(order) {
                                    ordersHtml += `
                                        <a class='list-group-item list-group-item-action'>
                                            <h5 class='list-group-item-heading'>Заказ #${order.order_id}</h5>
                                            <p class='list-group-item-text'>Дата: ${order.order_date}</p>
                                            <p class='list-group-item-text'>Сумма: ${order.total}</p>
                                            <p class='list-group-item-text'>Статус: ${order.status}</p>
                                        </a>
                                    `;
                                });
                                ordersHtml += `</div>`;
                            }
                            
                            $('#orders-container').html(ordersHtml);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#orders-container').html(`<div class='alert alert-danger'>Произошла ошибка при получении информации о заказах.</div>`);
                    }
                });
            }
            function getAllOrders() {
                $.ajax({
                    url: 'api/data/korzina/get_all_orders.php',
                    type: 'GET',
                    contentType: 'application/json',
                    success: function(response) {
                        if(response.error) {
                            console.log("Ошибка: " + response.error);
                        } else {
                            displayAllOrders(response);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log("Произошла ошибка при получении всех заказов.");
                    }
                });
            }
            function displayAllOrders(orders) {
                var ordersHtml = '<table class="table">';
                ordersHtml += `
                    <thead>
                        <tr>
                            <th>Номер заказа</th>
                            <th>Пользователь</th>
                            <th>Дата заказа</th>
                            <th>Сумма</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
                orders.forEach(function(order) {
                    ordersHtml += `
                        <tr>
                            <td>${order.order_id}</td>
                            <td>${order.firstname} ${order.lastname}</td>
                            <td>${order.order_date}</td>
                            <td>${order.total}</td>
                            <td><button class="btn btn-info view-order-details" data-order-id="${order.order_id}">Просмотреть детали</button>
                            </td>
                            <td>
                                <select class="form-control order-status" data-order-id="${order.order_id}">
                                    <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Обработка</option>
                                    <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Отправлен</option>
                                    <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Доставлен</option>
                                </select>
                            </td>
                            <td>
                                <button class="btn btn-primary update-order-status" data-order-id="${order.order_id}">Обновить статус</button>
                            </td>
                        </tr>`;
                });
            
                ordersHtml += '</tbody></table>';
                $('#admin-orders-container').html(ordersHtml);
            }
            // Обработчик нажатия на кнопку "Обновить статус"
            $(document).on('click', '.update-order-status', function() {
                var orderId = $(this).data('order-id');
                var status = $(this).closest('tr').find('.order-status').val();
                updateOrderStatus(orderId, status);
            });
            // Функция для обновления статуса заказа
            function updateOrderStatus(orderId, status) {
                $.ajax({
                    url: 'api/data/korzina/update_order_status.php',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ order_id: orderId, status: status }),
                    success: function(response) {
                        if(response.error) {
                            alert("Ошибка: " + response.error);
                        } else {
                            showNotification("Статус заказа обновлен.", false);
                            getAllOrders(); // Перезагрузить список заказов
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("Произошла ошибка при обновлении статуса заказа.");
                    }
                });
            }
              
            $(document).on('click', '.view-order-details', function() {
                var orderId = $(this).data('order-id');
                getOrderDetails(orderId);
            });
            function getOrderDetails(orderId) {
                $.ajax({
                    url: 'api/data/profile/get_order_details.php',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ order_id: orderId }),
                    success: function(response) {
                        if(response.error) {
                            alert("Ошибка: " + response.error);
                        } else {
                            displayOrderDetails(response, orderId);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("Произошла ошибка при получении деталей заказа.");
                    }
                });
            }
            function displayOrderDetails(orderDetails, orderId) {
                var detailsHtml = `<h4>Детали заказа #${orderId}</h4>`;
                detailsHtml += `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Название товара</th>
                                <th>Количество</th>
                                <th>Цена за единицу</th>
                                <th>Общая стоимость</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
                // Добавляем строки для каждого товара
                orderDetails.forEach(function(item) {
                    detailsHtml += `
                        <tr>
                            <td>${item.name}</td>
                            <td>${item.quantity}</td>
                            <td>${item.price}</td>
                            <td>${(item.price * item.quantity).toFixed(2)}</td>
                        </tr>`;
                });
            
                // Заканчиваем таблицу
                detailsHtml += `
                        </tbody>
                    </table>`;
                // Вставляем HTML в модальное окно или специальный контейнер
                $('#order-details-container').html(detailsHtml);
                // Показываем модальное окно или контейнер
                $('#orderDetailsModal').modal('show');
            } 
            
            function showNotification(message, isError) {
                var notification = $('#notification');
                notification.text(message).removeClass('error');
            
                if (isError) {
                    notification.addClass('error');
                }
            
                notification.fadeIn(500, function() {
                    // Уведомление исчезнет через 5 секунд
                    setTimeout(function() {
                        notification.fadeOut(500);
                    }, 5000);
                });
            }
            // function to make form values to json format
            $.fn.serializeObject = function(){
                var o = {};
                var a = this.serializeArray();
                $.each(a, function() {
                    if (o[this.name] !== undefined) {
                        if (!o[this.name].push) {
                            o[this.name] = [o[this.name]];
                        }
                        o[this.name].push(this.value || '');
                    } else {
                        o[this.name] = this.value || '';
                    }
                });
                return o;
            };
        });

    </script>
    
</body>
</html>